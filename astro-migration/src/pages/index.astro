---
import Layout from '../layouts/Layout.astro';
import { db } from '../db';
import { announcements } from '../db/schema';
import { eq } from 'drizzle-orm';

const activeAnnouncements = await db.select().from(announcements).where(eq(announcements.isActive, true)).limit(3);
const discordStats = { members: 450, channels: 10, bots: 5 };
---

<Layout title="CodeVerseHub - Discord Programming Community">
<!-- Hero Section (Static Redesign) -->
<section class="hero-static" aria-labelledby="heroTitle">
    <div class="hero-static-bg" aria-hidden="true"></div>
    <div class="container position-relative">
        <div class="row align-items-center g-5">
            <div class="col-xl-6 col-lg-7">
                <header class="hero-static-header">
                    <h1 id="heroTitle" class="hero-static-title">CodeVerseHub<br><span class="accent">Discord Dev Community</span></h1>
                    <p class="hero-static-sub">Learn faster, build smarter, stay motivated. A focused hub for coders who want feedback, resources, events & genuine collaboration.</p>
                </header>
                <ul class="hero-static-points" aria-label="Community benefits">
                    <li><i class="fas fa-bolt"></i> Fast help & peer debugging</li>
                    <li><i class="fas fa-layer-group"></i> Curated learning resources</li>
                    <li><i class="fas fa-trophy"></i> Weekly challenges & events</li>
                    <li><i class="fas fa-comments"></i> Inclusive, beginnerâ€‘friendly culture</li>
                </ul>
                <div class="hero-static-ctas">
                    <a href="https://discord.gg/3xKFvKhuGR" class="btn hero-primary" aria-label="Join CodeVerseHub Discord Server"><i class="fab fa-discord me-2"></i>Join Discord</a>
                    <a href="/about" class="btn hero-ghost" aria-label="Learn more about CodeVerseHub"><i class="fas fa-circle-info me-2"></i>Learn More</a>
                </div>
                <div class="hero-static-meta">
                    <div class="meta-item"><span class="num">{discordStats.members}+</span><span class="label">Members</span></div>
                    <div class="meta-item"><span class="num">{discordStats.channels}+</span><span class="label">Channels</span></div>
                    <div class="meta-item"><span class="num">{discordStats.bots}+</span><span class="label">Bots</span></div>
                </div>
            </div>
            <div class="col-xl-6 col-lg-5">
                <div class="hero-static-visual" aria-hidden="true">
                    <div class="orb orb-a"></div>
                    <div class="orb orb-b"></div>
                    <div class="mockup">
                        <i class="fab fa-discord"></i>
                        <span class="ring r1"></span>
                        <span class="ring r2"></span>
                        <span class="ring r3"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Discord Statistics -->
<section class="py-5 stats-section dark-bg">
    <div class="container">
        <div class="row text-center">
            <div class="col-md-4 col-sm-12 mb-4">
                <div class="stats-card glass-card">
                    <div class="stats-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <span class="number">{discordStats.members}+</span>
                    <span class="label">Discord Members</span>
                </div>
            </div>
            <div class="col-md-4 col-sm-6 mb-4">
                <div class="stats-card glass-card">
                    <div class="stats-icon">
                        <i class="fas fa-hashtag"></i>
                    </div>
                    <span class="number">{discordStats.channels}+</span>
                    <span class="label">Active Channels</span>
                </div>
            </div>
            <div class="col-md-4 col-sm-6 mb-4">
                <div class="stats-card glass-card">
                    <div class="stats-icon">
                        <i class="fas fa-robot"></i>
                    </div>
                    <span class="number">{discordStats.bots}+</span>
                    <span class="label">Helpful Bots</span>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Discord Channels Showcase -->
<section class="py-5 channels-section">
    <div class="container">
        <h2 class="text-center mb-5 section-title">Explore Our Discord Channels</h2>
        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="card glass-card h-100">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-hashtag gradient-icon"></i> General Channels</h5>
                        <ul class="list-group channel-list">
                            <li class="channel-item"><i class="fas fa-comment-dots"></i> #lobby</li>
                            <li class="channel-item"><i class="fas fa-comment-dots"></i> #dev-discussion</li>
                            <li class="channel-item"><i class="fas fa-comment-dots"></i> #introductions</li>
                            <li class="channel-item"><i class="fas fa-comment-dots"></i> #announcements</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="card glass-card h-100">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-hashtag gradient-icon"></i> Programming Channels</h5>
                        <ul class="list-group channel-list">
                            <li class="channel-item"><i class="fas fa-comment-dots"></i> #ask-for-help</li>
                            <li class="channel-item"><i class="fas fa-comment-dots"></i> #projects-showcase</li>
                            <li class="channel-item"><i class="fas fa-comment-dots"></i> #resources</li>
                            <li class="channel-item"><i class="fas fa-comment-dots"></i> #events</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="text-center mt-4">
            <a href="/resources" class="btn btn-gradient-outline">Explore Resources</a>
        </div>
    </div>
</section>

<!-- Features Section -->
<section class="py-5 features-section dark-bg">
    <div class="container">
        <h2 class="text-center mb-5 section-title">Discord Server Features</h2>
        <div class="row">
            <div class="col-md-4 mb-4">
                <div class="feature-card glass-card h-100 text-center">
                    <div class="card-body">
                        <div class="feature-icon">
                            <i class="fas fa-comments"></i>
                        </div>
                        <h5 class="card-title">Active Community</h5>
                        <p class="card-text">Engage with a vibrant community of programmers, from beginners to experts, ready to help and collaborate.</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="feature-card glass-card h-100 text-center">
                    <div class="card-body">
                        <div class="feature-icon">
                            <i class="fas fa-code"></i>
                        </div>
                        <h5 class="card-title">Code Help</h5>
                        <p class="card-text">Get assistance with your programming questions, code reviews, and debugging help from experienced members.</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="feature-card glass-card h-100 text-center">
                    <div class="card-body">
                        <div class="feature-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <h5 class="card-title">Fun Events</h5>
                        <p class="card-text">Participate in coding challenges, tech discussions, and community events to learn and have fun.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Recent Announcements -->
{activeAnnouncements.length > 0 && (
<section class="py-5 announcements-section">
    <div class="container">
        <h2 class="text-center mb-5 section-title">Recent Announcements</h2>
        <div class="row">
            {activeAnnouncements.map(announcement => (
            <div class="col-md-4 mb-4">
                <div class="card glass-card announcement-card">
                    <div class="card-body">
                        <div class="announcement-icon">
                            <i class="fas fa-bullhorn"></i>
                        </div>
                        <h6 class="card-title">{announcement.title}</h6>
                        <p class="card-text">{announcement.content.substring(0, 100)}...</p>
                        <div class="announcement-meta">
                            <span><i class="fas fa-user"></i> {announcement.createdBy}</span>
                            <span><i class="fas fa-calendar"></i> {new Date(announcement.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}</span>
                        </div>
                    </div>
                </div>
            </div>
            ))}
        </div>
    </div>
</section>
)}

<!-- Testimonials Section -->
<section class="py-5 testimonials-section dark-bg">
    <div class="container">
        <h2 class="text-center mb-5 section-title">What Our Community Says</h2>
        <div class="row">
            <!-- Testimonial 1 -->
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="testimonial-card glass-card h-100">
                    <div class="card-body">
                        <div class="testimonial-quote">
                            <i class="fas fa-quote-left"></i>
                        </div>
                        <p class="card-text">I've been on this server since July, and it's one of the best programming communities I've been part of. It is very active and friendly, and it also focuses on other things besides IT. Even if you're a complete beginner, this server is sure to welcome you and assist you if you are stuck or need help.</p>
                        <div class="testimonial-rating">
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="testimonial-user">
                            <div class="testimonial-info">
                                <h6 class="mb-0 gradient-text">Stefi Prokop</h6>
                                <span class="testimonial-role">@hyscript7</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Testimonial 2 -->
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="testimonial-card glass-card h-100">
                    <div class="card-body">
                        <div class="testimonial-quote">
                            <i class="fas fa-quote-left"></i>
                        </div>
                        <p class="card-text">The CodeVerse Hub is a very welcoming community with helpful and experienced people willing to help you at any moment. Everyone is supportive of each other and is treated nicely. It also has fun activities on the side to help you take a small break from hard coding sessions, relax and chill with other members. Overall a really good community to grow, connect and to have fun.</p>
                        <div class="testimonial-rating">
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="testimonial-user">
                            <div class="testimonial-info">
                                <h6 class="mb-0 gradient-text">MHIA</h6>
                                <span class="testimonial-role">@oyasumi_star09</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Testimonial 3 -->
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="testimonial-card glass-card h-100">
                    <div class="card-body">
                        <div class="testimonial-quote">
                            <i class="fas fa-quote-left"></i>
                        </div>
                        <p class="card-text">CodeVerse Hub is a welcoming, organized Discord community for programmers at every level. Supportive members and active channels make it a great place to learn, collaborate, and grow, with fun bots, coding challenges, and events to keep things engaging.</p>
                        <div class="testimonial-rating">
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="testimonial-user">
                            <div class="testimonial-info">
                                <h6 class="mb-0 gradient-text">Aditya Verma</h6>
                                <span class="testimonial-role">Community Founder</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Contact Section V2 -->
<section id="contact" class="contact-v2-wrapper gradient-bg dark-bg" aria-labelledby="contact-heading">
    <div class="contact-v2-orb orb-1"></div>
    <div class="contact-v2-orb orb-2"></div>
    <div class="container">
        <header class="contact-v2-header">
            <span class="contact-v2-eyebrow">Connect</span>
            <h2 id="contact-heading" class="contact-v2-title">Let's Build Something Together</h2>
            <p class="contact-v2-subtitle">Collaborate, ask questions or just say hi. The CodeVerseHub core team reads every message.</p>
        </header>
        <div class="contact-v2-grid">
            <!-- Info Panel -->
            <div class="contact-v2-panel glass-card" aria-labelledby="contact-info-heading">
                <h3 id="contact-info-heading" class="visually-hidden">Contact Information</h3>
                <ul class="contact-v2-info-list">
                    <li class="contact-v2-info-item">
                        <div class="contact-v2-icon-wrap"><i class="fas fa-envelope"></i></div>
                        <div class="contact-v2-info-body">
                            <span class="label">Email</span>
                            <a href="mailto:contact@codeversehub.com">contact@codeversehub.com</a>
                        </div>
                    </li>
                    <li class="contact-v2-info-item">
                        <div class="contact-v2-icon-wrap"><i class="fab fa-discord"></i></div>
                        <div class="contact-v2-info-body">
                            <span class="label">Discord</span>
                            <a href="https://discord.gg/3xKFvKhuGR">THE CODEVERSE HUB</a>
                        </div>
                    </li>
                    <li class="contact-v2-info-item">
                        <div class="contact-v2-icon-wrap"><i class="fas fa-globe"></i></div>
                        <div class="contact-v2-info-body">
                            <span class="label">Server Invite</span>
                            <a href="https://discord.gg/3xKFvKhuGR" target="_blank" rel="noopener">Join Discord</a>
                        </div>
                    </li>
                </ul>
                <div class="cvh-social-row" aria-label="Social links">
                    <a class="cvh-social-link" href="https://discord.gg/3xKFvKhuGR" aria-label="Discord"><i class="fab fa-discord"></i></a>
                    <a class="cvh-social-link" href="https://github.com/youngcoder45/cvhnewpyweb" aria-label="GitHub"><i class="fab fa-github"></i></a>
                    <a class="cvh-social-link" href="#" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
                    <a class="cvh-social-link" href="#" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                    <a class="cvh-social-link" href="#" aria-label="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
                </div>
            </div>
            <!-- Form Panel -->
            <div class="contact-v2-panel glass-card" aria-labelledby="contact-form-heading">
                <h3 id="contact-form-heading" class="visually-hidden">Send a Message</h3>
                <form id="contactForm" class="contact-v2-form" novalidate>
                    <div class="contact-v2-form-row">
                        <div class="field">
                            <input type="text" name="name" id="v2Name" placeholder=" " required />
                            <label for="v2Name">Name</label>
                        </div>
                        <div class="field">
                            <input type="email" name="email" id="v2Email" placeholder=" " required />
                            <label for="v2Email">Email</label>
                        </div>
                    </div>
                    <div class="field">
                        <input type="text" name="subject" id="v2Subject" placeholder=" " required />
                        <label for="v2Subject">Subject</label>
                    </div>
                    <div class="field">
                        <textarea name="message" id="v2Message" placeholder=" " required maxlength="1200"></textarea>
                        <label for="v2Message">Message</label>
                        <div class="char-counter-v2" id="cvhMessageCounter" aria-live="polite">0 / 1200 chars</div>
                    </div>
                    <button type="submit" class="contact-v2-submit"><i class="fas fa-paper-plane me-2"></i>Send Message</button>
                    <div id="formMessage" class="mt-3" style="display: none;"></div>
                </form>
            </div>
        </div>
    </div>
</section>

<!-- Call to Action V2 -->
<section class="cta-v2-wrapper" aria-labelledby="cta-heading">
    <div class="cta-v2-orb orb-a"></div>
    <div class="cta-v2-orb orb-b"></div>
    <div class="container">
        <div class="cta-v2-panel">
            <div class="cta-v2-content">
                <span class="cta-v2-eyebrow">Community</span>
                <h2 id="cta-heading" class="cta-v2-title">Join the Discord & Level Up Your Coding Journey</h2>
                <p class="cta-v2-text">Real-time collaboration, project feedback, curated resources, weekly events, coding challenges and a supportive network of developers across the globe. Dive in and build something awesome with us.</p>
                <div class="cta-v2-actions">
                    <a href="https://discord.gg/3xKFvKhuGR" class="cvh-btn-glow" aria-label="Join Discord Server">
                        <i class="fab fa-discord"></i><span>Join Discord</span>
                    </a>
                    <a href="/about" class="cvh-btn-outline" aria-label="Learn more about CodeVerseHub">
                        <i class="fas fa-circle-info"></i><span>Learn More</span>
                    </a>
                </div>
                <div class="cta-v2-badges" aria-hidden="true">
                    <span class="cta-v2-badge">Friendly Moderation</span>
                    <span class="cta-v2-badge">Weekly Events</span>
                    <span class="cta-v2-badge">Project Reviews</span>
                    <span class="cta-v2-badge">Resource Vault</span>
                    <span class="cta-v2-badge">Beginner Friendly</span>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
// Message character counter
const msgField = document.querySelector('#v2Message');
const counter = document.getElementById('cvhMessageCounter');
if (msgField && counter) {
    const warn = 900, danger = 1100, max = 1200;
    function update() {
        const len = msgField.value.length;
        counter.textContent = len + ' / ' + max + ' chars';
        counter.classList.remove('warning', 'danger');
        if (len > danger) counter.classList.add('danger');
        else if (len > warn) counter.classList.add('warning');
    }
    msgField.addEventListener('input', update);
    update();
}

// CTA button spark effect
const btn = document.querySelector('.cta-v2-actions .cvh-btn-glow');
if (btn) {
    const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    if (!prefersReduced) {
        function spawnSpark(e) {
            const spark = document.createElement('span');
            spark.className = 'cta-spark';
            const rect = btn.getBoundingClientRect();
            const x = e.offsetX || rect.width / 2;
            const y = e.offsetY || rect.height / 2;
            spark.style.left = x + 'px';
            spark.style.top = y + 'px';
            btn.appendChild(spark);
            setTimeout(() => spark.remove(), 900);
        }
        btn.addEventListener('pointermove', (ev) => {
            if (Math.random() < 0.15) {
                spawnSpark(ev);
            }
        });
    }
}

// Contact form submission
const contactForm = document.getElementById('contactForm');
const formMessage = document.getElementById('formMessage');

if (contactForm && formMessage) {
    contactForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = {
            name: document.getElementById('v2Name').value,
            email: document.getElementById('v2Email').value,
            subject: document.getElementById('v2Subject').value,
            message: document.getElementById('v2Message').value
        };
        
        try {
            const response = await fetch('/api/contact', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });
            
            const result = await response.json();
            
            formMessage.style.display = 'block';
            if (response.ok) {
                formMessage.className = 'alert alert-success';
                formMessage.textContent = result.message || 'Message sent successfully!';
                contactForm.reset();
                if (counter) counter.textContent = '0 / 1200 chars';
            } else {
                formMessage.className = 'alert alert-danger';
                formMessage.textContent = result.error || 'Failed to send message. Please try again.';
            }
        } catch (error) {
            formMessage.style.display = 'block';
            formMessage.className = 'alert alert-danger';
            formMessage.textContent = 'An error occurred. Please try again later.';
        }
    });
}
</script>

<style>
/* Inline tiny style for spark (kept local to CTA) */
.cvh-btn-glow { position:relative; }
.cvh-btn-glow .cta-spark { position:absolute; width:10px; height:10px; pointer-events:none; background:radial-gradient(circle at 30% 30%, #fff, rgba(255,255,255,0) 70%); border-radius:50%; filter:brightness(1.8) drop-shadow(0 0 4px rgba(0,229,255,0.9)); animation:ctaSpark 0.9s ease-out forwards; }
@keyframes ctaSpark { 0% { transform:translate(-50%, -50%) scale(0.3); opacity:1;} 70% { opacity:1; } 100% { transform:translate(-50%, -50%) scale(1.8); opacity:0;} }
</style>
</Layout>
